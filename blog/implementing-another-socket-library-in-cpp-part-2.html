<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.49">
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-2R87B0XZCL"></script><script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){
          dataLayer.push(arguments);
        }
        gtag('js', new Date());
        gtag('config', 'G-2R87B0XZCL');
      </script><title>Implementing another socket library in C++ - Part 2 | Rsomething <Personal Blog/></title><meta name="description" content="Rsomething's Personal Blog">
    <link rel="modulepreload" href="/assets/app.b78311c0.js"><link rel="modulepreload" href="/assets/implementing-another-socket-library-in-cpp-part-2.html.81a6540d.js"><link rel="modulepreload" href="/assets/implementing-another-socket-library-in-cpp-part-2.html.f66f073f.js"><link rel="prefetch" href="/assets/index.html.3c2c7787.js"><link rel="prefetch" href="/assets/a-new-start.html.3bfc6d59.js"><link rel="prefetch" href="/assets/implementing-go-style-struct-tags-part-1.html.ac12148f.js"><link rel="prefetch" href="/assets/setjmp-longjmp-in-c-part-1.html.ad726d0c.js"><link rel="prefetch" href="/assets/implementing-another-socket-library-in-cpp-part-1.html.b0bc5e2e.js"><link rel="prefetch" href="/assets/implementing-another-socket-library-in-cpp-part-3.html.3df8be2d.js"><link rel="prefetch" href="/assets/implementing-go-style-struct-tags-part-2.html.34d7b5dc.js"><link rel="prefetch" href="/assets/user-defined-literals-in-cpp.html.45c96f36.js"><link rel="prefetch" href="/assets/linear-algebra-the-basics.html.50f1004d.js"><link rel="prefetch" href="/assets/how-to-calculate-motor-rating-for-mobile-robots.html.95bd3b74.js"><link rel="prefetch" href="/assets/resistor-network-for-keypad-calculation.html.e81bdf62.js"><link rel="prefetch" href="/assets/404.html.ce538133.js"><link rel="prefetch" href="/assets/index.html.e5d2d16e.js"><link rel="prefetch" href="/assets/index.html.3f8b9b2e.js"><link rel="prefetch" href="/assets/index.html.f3db06eb.js"><link rel="prefetch" href="/assets/index.html.1f2ed00a.js"><link rel="prefetch" href="/assets/a-new-start.html.e4a43ea9.js"><link rel="prefetch" href="/assets/implementing-go-style-struct-tags-part-1.html.becae05c.js"><link rel="prefetch" href="/assets/setjmp-longjmp-in-c-part-1.html.ae103e32.js"><link rel="prefetch" href="/assets/implementing-another-socket-library-in-cpp-part-1.html.836fbdc8.js"><link rel="prefetch" href="/assets/implementing-another-socket-library-in-cpp-part-3.html.5a22ca0c.js"><link rel="prefetch" href="/assets/implementing-go-style-struct-tags-part-2.html.6ecd0592.js"><link rel="prefetch" href="/assets/user-defined-literals-in-cpp.html.45d8872f.js"><link rel="prefetch" href="/assets/linear-algebra-the-basics.html.b7018bf4.js"><link rel="prefetch" href="/assets/how-to-calculate-motor-rating-for-mobile-robots.html.6c049e21.js"><link rel="prefetch" href="/assets/resistor-network-for-keypad-calculation.html.20f5eb2b.js"><link rel="prefetch" href="/assets/404.html.9aff8135.js"><link rel="prefetch" href="/assets/index.html.899f9ecc.js"><link rel="prefetch" href="/assets/index.html.29881b68.js"><link rel="prefetch" href="/assets/index.html.841a157d.js"><link rel="prefetch" href="/assets/404.4e9d3fdf.js"><link rel="prefetch" href="/assets/CategoriesLayout.9e31fe91.js"><link rel="prefetch" href="/assets/HomeLayout.bd71f3b3.js"><link rel="prefetch" href="/assets/Layout.ea5b662c.js"><link rel="prefetch" href="/assets/PostLayout.162cfa7c.js"><link rel="prefetch" href="/assets/PostsLayout.decfb82f.js"><link rel="prefetch" href="/assets/SearchLayout.4e333fe7.js"><link rel="prefetch" href="/assets/TagsLayout.0715536d.js">
    <link rel="stylesheet" href="/assets/style.cec478b6.css">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><header class="theme-header"><a href="/" class="logo-link" style=""><!----><strong class="title">Rsomething &lt;Personal Blog/&gt;</strong></a><!----><nav class="navbar"><i class="iconfont icon-menu menu-btn"></i><ul class="nav-list"><li class="nav-item"><div class="navbar-blogger"><div class="avatar"><img src="/images/avatar.jpg" alt="Avatar" title="Avatar"></div><div class="types"><a href="/categories/?category=all" class="type"><span class="text">Categories</span><span class="num">11</span></a><div class="divider"></div><a href="/tags/?tag=all" class="type"><span class="text">Tags</span><span class="num">13</span></a></div><div class="blogger"><div class="name">Rsomething</div><p class="slogan" title="Personal Blog And Programming Notes.">Personal Blog And Programming Notes.</p></div></div></li><!--[--><!--]--><li class="nav-link nav-item animate__animated animate__slideInRight"><button class="theme-toggle"><i class="icon-sun iconfont"></i></button></li><li class="nav-link nav-item animate__animated animate__slideInRight search-link"><a href="/search/" class="navbar-item"><i class="icon-search iconfont"></i><span class="text">Search</span></a></li><li class="nav-item nav-medias animate__animated animate__slideInRight"><div class="medias"><!--[--><a class="icon-email iconfont" href="mailto:rkm7232@gmail.com" title="email" target="_blank"></a><a class="icon-github iconfont" href="https://github.com/the-this-pointer/" title="github" target="_blank"></a><a class="icon-book iconfont" href="https://the-this-pointer.github.io/my-resume/" title="book" target="_blank"></a><!--]--></div></li></ul></nav></header><main class="theme-container theme-post-container"><div class="theme-content post-container"><div class="post-wrapper"><i class="iconfont icon-book toc-btn"></i><i class="iconfont icon-menu aside-btn"></i><div class="markdown-body"><h1 class="post-title"><span>Implementing another socket library in C++ - Part 2</span></h1><div class="post-info"><span class="post-info-item"><i class="iconfont icon-avatar" title="Author"></i> Rsomething</span><span class="post-info-item"><i class="iconfont icon-datetime" title="Date"></i> 2022-08-20</span><span class="post-info-item"><i class="iconfont icon-categorynormal" title="Categories"></i><!--[--><a href="/categories/?category=C%2B%2B" class="post-type">C++</a><!--]--></span><span class="post-info-item"><i class="iconfont icon-tag" title="Tags"></i><!--[--><a href="/tags/?tag=programming" class="post-type">programming</a><!--]--></span></div><div><p>In the previous part, we discussed what and how we want to implement the library generally. In this post we are going to implement bottom-layer socket methods.</p><details class="custom-container details"><p>This is a part of implementing a socket network library series. The list will be updated as soon as new articles are added.</p><p><a href="implementing-another-socket-library-in-cpp-part-1.html" target="_blank">Implementing another socket library in C++ - Part 1</a>.</p><blockquote><p><em>Implementing another socket library in C++ - Part 2</em></p></blockquote><p><a href="implementing-another-socket-library-in-cpp-part-3.html" target="_blank">Implementing another socket library in C++ - Part 3</a>.</p></details><h2 id="implementing-bottom-layer-methods" tabindex="-1"><a class="header-anchor" href="#implementing-bottom-layer-methods" aria-hidden="true">#</a> Implementing Bottom-Layer Methods</h2><p>In this part, we will create a new project for the library and add a file named <code>net_p.h</code> for bottom-layer socket methods. To use these methods, I will link the <code>ws2_32</code> (named: <code>Winsock</code> library) to the executable in <code>CMakeLists.txt</code>, this step is necessary for windows only, and we will return to link some other libraries for windows and unix later.</p><p>I add a namespace to group the methods in the new file I&#39;ve just created. When I want to implement the Unix methods, I will use macros to handle all of differences between Windows and Unix in one file and split the blocks for each platform.</p><p>One thing about the Winsock library is that it needs initialization (<code>WSAStartup</code>) at the program&#39;s start. It initializes the library DLL and ensures that the Winsock API is supported by the platform and cleanup (<code>WSACleanup</code>) at the end of the code. Also, we can get the occurred error codes with the method <code>WSAGetLastError</code>. We can use the error code to get a description from another windows API method if it&#39;s necessary.</p><p>The API methods take a socket descriptor and operate the needed action on it, like setting a flag, sending data, receiving data, etc.</p><p>For creating a socket, we should declare an <code>addrinfo</code> object and give it some information about the socket type and the address type we plan to use. Socket types are noted in the first part of this article. It can be <code>TCP</code> or <code>UDP</code>. The address type can be <code>IPv4</code>, <code>IPv6</code>, or the unspecified value to tell the API it can be either.</p><p>So, after all of these, we need the following methods:</p><ul><li><code>initialize</code>: Initialize the Winsock API.</li></ul><div class="language-cpp ext-cpp line-numbers-mode"><pre class="language-cpp"><code>  <span class="token keyword">int</span> <span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    WSADATA wsaData<span class="token punctuation">;</span>
    <span class="token keyword">int</span> iResult <span class="token operator">=</span> <span class="token function">WSAStartup</span><span class="token punctuation">(</span><span class="token function">MAKEWORD</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>wsaData<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>iResult <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      paad<span class="token double-colon punctuation">::</span>gNetInitialized <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> iResult<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>cleanup</code>: Cleanup and uninitialize Winsock API.</li></ul><div class="language-cpp ext-cpp line-numbers-mode"><pre class="language-cpp"><code>  <span class="token keyword">int</span> <span class="token function">cleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">WSACleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>connect</code>: Connect to the endpoint.</li></ul><div class="language-cpp ext-cpp line-numbers-mode"><pre class="language-cpp"><code>  <span class="token keyword">int</span> <span class="token function">connect</span><span class="token punctuation">(</span>SOCKET<span class="token operator">&amp;</span> sock<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> address<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> port<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> <span class="token operator">*</span>result <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token operator">*</span>ptr <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    result <span class="token operator">=</span> <span class="token function">addressinfo</span><span class="token punctuation">(</span>address<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> result <span class="token operator">==</span> <span class="token keyword">nullptr</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Attempt to connect to an address until one succeeds</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>ptr<span class="token operator">=</span>result<span class="token punctuation">;</span> ptr <span class="token operator">!=</span> <span class="token keyword">nullptr</span> <span class="token punctuation">;</span>ptr<span class="token operator">=</span>ptr<span class="token operator">-&gt;</span>ai_next<span class="token punctuation">)</span> <span class="token punctuation">{</span>

      <span class="token comment">// Create a SOCKET for connecting to server</span>
      sock <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>ptr<span class="token operator">-&gt;</span>ai_family<span class="token punctuation">,</span> ptr<span class="token operator">-&gt;</span>ai_socktype<span class="token punctuation">,</span>
                             ptr<span class="token operator">-&gt;</span>ai_protocol<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>sock <span class="token operator">==</span> INVALID_SOCKET<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// Connect to server.</span>
      <span class="token keyword">int</span> iResult <span class="token operator">=</span> <span class="token function">connect</span><span class="token punctuation">(</span> sock<span class="token punctuation">,</span> ptr<span class="token operator">-&gt;</span>ai_addr<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>ptr<span class="token operator">-&gt;</span>ai_addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>iResult <span class="token operator">==</span> SOCKET_ERROR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">closesocket</span><span class="token punctuation">(</span>sock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">WSACleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sock <span class="token operator">=</span> INVALID_SOCKET<span class="token punctuation">;</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">freeaddrinfo</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>sock <span class="token operator">==</span> INVALID_SOCKET<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>snd</code>: Send data to the endpoint.</li></ul><div class="language-cpp ext-cpp line-numbers-mode"><pre class="language-cpp"><code>    <span class="token keyword">int</span> <span class="token function">snd</span><span class="token punctuation">(</span>SOCKET sock<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> buffer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> iResult <span class="token operator">=</span> <span class="token function">send</span><span class="token punctuation">(</span> sock<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">strlen</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>iResult <span class="token operator">==</span> SOCKET_ERROR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">closesocket</span><span class="token punctuation">(</span>sock<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">WSACleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> iResult<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>rcv</code>: Receive data from the endpoint.</li></ul><div class="language-cpp ext-cpp line-numbers-mode"><pre class="language-cpp"><code>  <span class="token keyword">int</span> <span class="token function">rcv</span><span class="token punctuation">(</span>SOCKET sock<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> buffer<span class="token punctuation">,</span> <span class="token keyword">int</span> len<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> iResult <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
      iResult <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>sock<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> len<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span> iResult <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">WSAGetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> WSAETIMEDOUT<span class="token punctuation">)</span>
          <span class="token keyword">return</span> ETIMEDOUT<span class="token punctuation">;</span>
        <span class="token function">closesocket</span><span class="token punctuation">(</span>sock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">WSACleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// error occured, check WSAGetLastError()</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> iResult <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">//Connection closed</span>

    <span class="token punctuation">}</span> <span class="token keyword">while</span><span class="token punctuation">(</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> iResult<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>shutdown</code>: Used to terminate a side from sending data. We can use this to tell the server we have done sending data and will never send any additional information, so the server can clean up some resources. In this example, we can still receive data from the server.</li></ul><div class="language-cpp ext-cpp line-numbers-mode"><pre class="language-cpp"><code>  <span class="token keyword">int</span> <span class="token function">shutdown</span><span class="token punctuation">(</span>SOCKET sock<span class="token punctuation">,</span> <span class="token keyword">char</span> c<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> iResult <span class="token operator">=</span> <span class="token double-colon punctuation">::</span><span class="token function">shutdown</span><span class="token punctuation">(</span>sock<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>iResult <span class="token operator">==</span> SOCKET_ERROR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">closesocket</span><span class="token punctuation">(</span>sock<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">WSACleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> iResult<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>close</code>: Close a socket at the end of communication.</li></ul><div class="language-cpp ext-cpp line-numbers-mode"><pre class="language-cpp"><code>  <span class="token keyword">int</span> <span class="token function">close</span><span class="token punctuation">(</span>SOCKET sock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> iResult <span class="token operator">=</span> <span class="token function">closesocket</span><span class="token punctuation">(</span>sock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> iResult<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>listen</code>: Listen on a port to accept new clients.</li></ul><div class="language-cpp ext-cpp line-numbers-mode"><pre class="language-cpp"><code>    <span class="token keyword">int</span> <span class="token function">listen</span><span class="token punctuation">(</span>SOCKET<span class="token operator">&amp;</span> sock<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> address<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> port<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> <span class="token operator">*</span>result <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token operator">*</span>ptr <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    result <span class="token operator">=</span> <span class="token function">addressinfo</span><span class="token punctuation">(</span>address<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> result <span class="token operator">==</span> <span class="token keyword">nullptr</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    sock <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>result<span class="token operator">-&gt;</span>ai_family<span class="token punctuation">,</span> result<span class="token operator">-&gt;</span>ai_socktype<span class="token punctuation">,</span> result<span class="token operator">-&gt;</span>ai_protocol<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sock <span class="token operator">==</span> INVALID_SOCKET<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">freeaddrinfo</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">WSACleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Setup the TCP listening socket</span>
    <span class="token keyword">int</span> iResult <span class="token operator">=</span> <span class="token function">bind</span><span class="token punctuation">(</span> sock<span class="token punctuation">,</span> result<span class="token operator">-&gt;</span>ai_addr<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>result<span class="token operator">-&gt;</span>ai_addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>iResult <span class="token operator">==</span> SOCKET_ERROR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">freeaddrinfo</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">closesocket</span><span class="token punctuation">(</span>sock<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">WSACleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">freeaddrinfo</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>

    iResult <span class="token operator">=</span> <span class="token double-colon punctuation">::</span><span class="token function">listen</span><span class="token punctuation">(</span>sock<span class="token punctuation">,</span> SOMAXCONN<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>iResult <span class="token operator">==</span> SOCKET_ERROR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">closesocket</span><span class="token punctuation">(</span>sock<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">WSACleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>accept</code>: Accept new clients that want to connect to the server. This will perform on a listening socket and return a new socket connected to the client.</li></ul><div class="language-cpp ext-cpp line-numbers-mode"><pre class="language-cpp"><code>  SOCKET <span class="token function">accept</span><span class="token punctuation">(</span>SOCKET sock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Accept a client socket</span>
    SOCKET cliSocket <span class="token operator">=</span> <span class="token double-colon punctuation">::</span><span class="token function">accept</span><span class="token punctuation">(</span>sock<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cliSocket <span class="token operator">==</span> INVALID_SOCKET<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;accept error: &quot;</span> <span class="token operator">&lt;&lt;</span> <span class="token function">WSAGetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
      <span class="token function">closesocket</span><span class="token punctuation">(</span>sock<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">WSACleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> INVALID_SOCKET<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> cliSocket<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>setsockopt</code>: Set some options for the socket, like timeouts, blocking mode, etc.</li></ul><div class="language-cpp ext-cpp line-numbers-mode"><pre class="language-cpp"><code>  <span class="token keyword">int</span> <span class="token function">setsockopt</span><span class="token punctuation">(</span>SOCKET sock<span class="token punctuation">,</span> <span class="token keyword">int</span> opt<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span><span class="token operator">*</span> val<span class="token punctuation">,</span> <span class="token keyword">int</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> s <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>val<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token double-colon punctuation">::</span><span class="token function">setsockopt</span><span class="token punctuation">(</span>sock<span class="token punctuation">,</span> SOL_SOCKET<span class="token punctuation">,</span> opt<span class="token punctuation">,</span> s<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>One other method to prevent code duplication is:</p><ul><li><code>addressinfo</code>: This method takes the endpoint address and returns the resolved address to use in <code>connect</code> or <code>listen</code>.</li></ul><div class="language-cpp ext-cpp line-numbers-mode"><pre class="language-cpp"><code>  <span class="token keyword">struct</span> <span class="token class-name">addrinfo</span><span class="token operator">*</span> <span class="token function">addressinfo</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> address<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> port<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> <span class="token operator">*</span>result <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token operator">*</span>ptr <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> hints<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token function">ZeroMemory</span><span class="token punctuation">(</span> <span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>hints<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    hints<span class="token punctuation">.</span>ai_family <span class="token operator">=</span> AF_UNSPEC<span class="token punctuation">;</span>
    hints<span class="token punctuation">.</span>ai_socktype <span class="token operator">=</span> SOCK_STREAM<span class="token punctuation">;</span>
    hints<span class="token punctuation">.</span>ai_protocol <span class="token operator">=</span> IPPROTO_TCP<span class="token punctuation">;</span>

    <span class="token comment">// Resolve the server address and port</span>
    <span class="token keyword">int</span> iResult <span class="token operator">=</span> <span class="token function">getaddrinfo</span><span class="token punctuation">(</span>address<span class="token punctuation">,</span> port<span class="token punctuation">,</span> <span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token operator">&amp;</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> iResult <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>So far, we have implemented <code>TCP</code>, <code>blocking</code> methods only, and results for the <code>non-blocking</code> sockets will be different.</p><div class="custom-container tip"><p class="custom-container-title">TIP</p><p>You can watch what I&#39;ve done in this <a href="https://github.com/the-this-pointer/network-library" target="_blank">Github repo</a>.</p></div></div></div><div class="theme-divider"></div><div class="giscus-comment"><!----></div></div><div class="card-box card-wrapper post-tocs"><header><h3 class="title"><i class="iconfont icon-categorynormal"></i><span> Contents </span></h3></header><nav class="vuepress-toc"><ul class="vuepress-toc-list"><li class="vuepress-toc-item"><a aria-current="page" href="/blog/implementing-another-socket-library-in-cpp-part-2.html#implementing-bottom-layer-methods" class="router-link-active router-link-exact-active vuepress-toc-link" arialabel="Implementing Bottom-Layer Methods">Implementing Bottom-Layer Methods</a><!--[--><!--]--></li></ul></nav></div></div></main><footer class="theme-footer theme-common-footer"><div class="copyright"><a class="beian" href="https://the-this-pointer.github.io">With ❤️ From Iran</a><span class="delimiter">|</span><span class="info">Copyright © 2022-2024 Rsomething &lt;Personal Blog/&gt;</span></div></footer><div style="display:none;" class="back-to-top"><i class="iconfont icon-back-to-top"></i></div><!--]--><!--]--></div>
    <script type="module" src="/assets/app.b78311c0.js" defer></script>
  </body>
</html>
